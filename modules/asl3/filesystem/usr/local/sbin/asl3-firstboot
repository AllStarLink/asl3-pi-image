#!/usr/bin/bash

if [ -e /asl3-first-boot-needed ]; then
	rm /asl3-first-boot-needed

	# UFW Configuration
#	ufw default deny incoming
#	ufw default allow outgoing
#	ufw allow ssh
#	ufw allow http
#	ufw allow https
#	ufw allow 4560:4580/udp comment 'IAX2 ports'
#	ufw allow 9090/tcp comment 'Cockpit'
#	ufw allow from any app Bonjour
#	ufw enable
#	systemctl enable ufw
#	systemctl start ufw

	# FirewallD configuration
	firewall-cmd -p 1667:udp
	firewall-cmd -p 4560-4580:udp
	firewall-cmd -s cockpit
	firewall-cmd -s http
	firewall-cmd -s https
	firewall-cmd -s mdns
	firewall-cmd -s ssh
	systemctl enable firewalld
	systemctl restart firewalld	

	# Regenerate the snakeoil certificate	
	THISHOST=$(hostnamectl hostname)
	openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
	    -keyout /etc/ssl/private/ssl-cert-snakeoil.key \
    	-out /etc/ssl/certs/ssl-cert-snakeoil.pem -subj \
		"/CN=${THISHOST}.local"
	systemctl restart apache2

	# Regenerate the Cockpit certificate
	openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
        -keyout /etc/cockpit/ws-certs.d/0-self-signed.key
        -out /etc/cockpit/ws-certs.d/0-self-signed.cert -subj \
        "/CN=${THISHOST}.local"

	# Regenrate SSH keys 
	systemctl stop ssh
	rm /etc/ssh/ssh_host*key*
	ssh-keygen -A
	systemctl start ssh

	# Disable firstboot
	systemctl disable asl3-firstboot

fi

